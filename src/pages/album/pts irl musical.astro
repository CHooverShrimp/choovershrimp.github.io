---
import Layout from '@layouts/Layout.astro';
import { Image } from 'astro:assets';

import coverArt from '@assets/cover.jpg'

import {musicList} from '@components/pts-irl-musical.astro'
---
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

<Layout title="PTS v.IRL - The Mare-sical! Official Soundtrack">
    <div id="wrapper" class="main my-20 max-w-196 px-10 text-white">
        <div class="flex md:flex-row flex-col space-x-4 items-center">
            <Image src={coverArt} transition:name="maresical" format="avif" alt="" width="350" class="rounded shadow-xl "/>
            <div class="header space-x-4 my-5">
                <h1 class="md:text-4xl text-3xl font-bold"> PTS v.IRL - The Mare-sical!</h1>
                <h1 class="text-2xl mt-5"> PTS v.IRL </h1>
                <h1 class="text-2xl"> 2025 </h1>

                <select
                    id="download"
                    class="rounded border-gray-300 shadow-sm px-4 py-2 bg-white text-black mt-5 cursor-pointer"
                >
                    <option value="">Download</option>
                    <option value="bundle-flac">FLAC (Bundle All Tracks)</option>
                    <option value="https://static.pts-irl.live/PTS%20v.IRL%20-%20The%20MARE-sical!%20OST%20-%20M4A.zip">M4A</option>
                </select>
            </div>
        </div>

        <div class="pt-20">
        {
            musicList.map((music,index) =>
                <hr/>
                <div id={music.name.replace(/\s+/g, '')} class="music flex justify-between items-center py-4 px-4 hover:bg-white/10 cursor-pointer" data-url={music.url}>
                    <div class="flex">
                        <div class="w-10"> {index + 1}. </div>
                        <div> {music.name} </div>
                    </div>
                    <div class="duration text-gray-400 text-sm ml-4">
                        {music.url ? '--:--' : ''}
                    </div>
                </div>
            )
        }
        <hr/>
        </div>

        <div id="footer-space" class="mb-20">
    </div>

    <!-- Music Player Controller -->
    <div id="player" class="fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700 p-4 translate-y-full transition-all">
        <div class="max-w-7xl mx-auto">

            <!-- Track Info (Mobile) -->
            <div class="flex items-center justify-between mb-3 sm:hidden block">
                <div class="flex-1 min-w-0">
                    <div id="" class="current-track text-white font-semibold truncate">No track playing</div>
                    <div id="" class="current-artist text-gray-400 text-sm">PTS v.IRL</div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mb-3">
                <input
                    type="range"
                    id="progress-bar"
                    class="w-full h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer accent-white"
                    min="0"
                    max="100"
                    value="0"
                />
                <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row items-center justify-between">
                <!-- Track Info (left) -->
                <div class="flex-1">
                    <div class="hidden sm:flex items-center justify-between mb-3">
                        <div class="flex-1 min-w-0">
                            <div id="" class="current-track text-white font-semibold truncate">No track playing</div>
                            <div id="" class="current-artist text-gray-400 text-sm">PTS v.IRL</div>
                        </div>
                    </div>
                </div>

                <!-- Play/pause/next (centered) -->
                <div class="flex items-center space-x-4">
                    <button id="prev-btn" class="text-white hover:text-gray-300 transition">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                        </svg>
                    </button>
                    <button id="play-pause-btn" class="bg-white text-gray-900 rounded-full p-3 hover:scale-105 transition">
                        <svg id="play-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <svg id="pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M6 4h4v16H6zm8 0h4v16h-4z"/>
                        </svg>
                    </button>
                    <button id="next-btn" class="text-white hover:text-gray-300 transition">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16 18h2V6h-2zm-11-1l8.5-6L5 5z"/>
                        </svg>
                    </button>
                </div>

                <!-- Volume Control (right side) -->
                <div class="flex items-center space-x-2 flex-1 justify-end sm:sm-0 mt-5">
                    <button id="mute-btn" class="text-white hover:text-gray-300 transition">
                        <svg id="volume-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                        </svg>
                        <svg id="mute-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                        </svg>
                    </button>
                    <input
                        type="range"
                        id="volume-bar"
                        class="w-24 h-2 bg-gray-500 rounded-lg appearance-none cursor-pointer accent-white"
                        min="0"
                        max="100"
                        value="100"
                    />
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', function()
    {
        function formatDuration(seconds: number): string {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Load audio durations for all tracks
        document.querySelectorAll('.music').forEach((el) => {
            const url = el.getAttribute('data-url');
            const durationEl = el.querySelector('.duration');

            if (url && durationEl) {
                const audio = new Audio(url);

                audio.addEventListener('loadedmetadata', () => {
                    if (audio.duration && isFinite(audio.duration)) {
                        durationEl.textContent = formatDuration(audio.duration);
                    }
                });

                audio.addEventListener('error', () => {
                    durationEl.textContent = '';
                });
            }
        });

        // Music Player Controller
        const player = document.getElementById('player');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar') as HTMLInputElement;
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const currentTrackEl = document.querySelectorAll('.current-track');
        const volumeBar = document.getElementById('volume-bar') as HTMLInputElement;
        const muteBtn = document.getElementById('mute-btn');
        const volumeIcon = document.getElementById('volume-icon');
        const muteIcon = document.getElementById('mute-icon');

        let audio: HTMLAudioElement | null = null;
        let currentTrackIndex = -1;
        const tracks = Array.from(document.querySelectorAll('.music')).filter(el => el.getAttribute('data-url'));

        function playTrack(index: number) {
            if (index < 0 || index >= tracks.length) return;

            const trackEl = tracks[index];
            const url = trackEl.getAttribute('data-url');
            const name = trackEl.querySelector('div:nth-child(2)')?.textContent?.trim();

            if (!url) return;

            if (audio) {
                audio.pause();
            }

            audio = new Audio(url);
            currentTrackIndex = index;
            currentTrackEl.forEach((track) => {
                track.textContent = name || 'Unknown Track';
            });
            player!.classList.remove('translate-y-full');

            // Set volume from slider
            audio.volume = Number(volumeBar!.value) / 100;

            audio.addEventListener('loadedmetadata', () => {
                totalTimeEl!.textContent = formatDuration(audio!.duration);
                progressBar!.max = String(audio!.duration);
            });

            audio.addEventListener('timeupdate', () => {
                currentTimeEl!.textContent = formatDuration(audio!.currentTime);
                progressBar!.value = String(audio!.currentTime);
            });

            audio.addEventListener('ended', () => {
                playNext();
            });

            audio.play();
            playIcon!.classList.add('hidden');
            pauseIcon!.classList.remove('hidden');
        }

        function togglePlayPause() {
            if (!audio) return;

            if (audio.paused) {
                audio.play();
                playIcon!.classList.add('hidden');
                pauseIcon!.classList.remove('hidden');
            } else {
                audio.pause();
                playIcon!.classList.remove('hidden');
                pauseIcon!.classList.add('hidden');
            }
        }

        function playNext() {
            if (currentTrackIndex < tracks.length - 1) {
                playTrack(currentTrackIndex + 1);
            }
        }

        function playPrev() {
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        }

        // Event Listeners
        playPauseBtn?.addEventListener('click', togglePlayPause);
        nextBtn?.addEventListener('click', playNext);
        prevBtn?.addEventListener('click', playPrev);

        progressBar?.addEventListener('input', (e) => {
            if (audio) {
                audio.currentTime = Number((e.target as HTMLInputElement).value);
            }
        });

        volumeBar?.addEventListener('input', (e) => {
            if (audio) {
                const volume = Number((e.target as HTMLInputElement).value) / 100;
                audio.volume = volume;
                updateVolumeIcon(volume);
            }
        });

        muteBtn?.addEventListener('click', () => {
            if (audio) {
                if (audio.volume > 0) {
                    audio.volume = 0;
                    volumeBar!.value = '0';
                    updateVolumeIcon(0);
                } else {
                    audio.volume = 1;
                    volumeBar!.value = '100';
                    updateVolumeIcon(1);
                }
            }
        });

        function updateVolumeIcon(volume: number) {
            if (volume === 0) {
                volumeIcon!.classList.add('hidden');
                muteIcon!.classList.remove('hidden');
            } else {
                volumeIcon!.classList.remove('hidden');
                muteIcon!.classList.add('hidden');
            }
        }

        // Click on track to play
        tracks.forEach((trackEl, index) => {
            trackEl.addEventListener('click', () => {
                playTrack(index);
            });
        });
    });




    // DOWNLOAD FLAC

    document.addEventListener('astro:page-load', function() {
        const downloadSelect = document.getElementById('download') as HTMLSelectElement;

        if (downloadSelect) {
            downloadSelect.addEventListener('change', async function(e) {
                const value = this.value;

                // Check if it's the bundle FLAC option
                if (value === 'bundle-flac') {
                    e.preventDefault();
                    this.value = ''; // Reset dropdown
                    await bundleAndDownloadTracks();
                } else if (value) {
                    // Let the existing direct download links work
                    window.location.href = value;
                }
            });
        }
    });

    async function bundleAndDownloadTracks() {
        // Get all tracks from musicList
        const tracks = Array.from(document.querySelectorAll('.music'))
            .filter(el => el.getAttribute('data-url'))
            .map(el => ({
                url: el.getAttribute('data-url')!,
                name: el.querySelector('div:nth-child(2)')?.textContent?.trim() || 'Unknown'
            }));

        if (tracks.length === 0) {
            alert('No tracks available to download');
            return;
        }

        // Show progress indicator
        const progressDiv = document.createElement('div');
        progressDiv.id = 'download-progress';
        progressDiv.className = 'fixed top-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-xl z-50';
        progressDiv.innerHTML = `
            <div class="font-semibold mb-2">Preparing Download...</div>
            <div class="text-sm text-gray-400">0 of ${tracks.length} tracks</div>
            <div class="w-64 bg-gray-700 rounded-full h-2 mt-2">
                <div id="progress-fill" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
            </div>
        `;
        document.body.appendChild(progressDiv);

        try {
            // @ts-ignore - JSZip loaded via CDN
            const zip = new JSZip();
            const folder = zip.folder('PTS v.IRL - The MARE-sical OST');

            // Download each track
            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];

                // Update progress
                const progressText = progressDiv.querySelector('.text-sm');
                const progressFill = document.getElementById('progress-fill');
                if (progressText) progressText.textContent = `${i + 1} of ${tracks.length} tracks`;
                if (progressFill) progressFill.style.width = `${((i + 1) / tracks.length) * 100}%`;

                try {
                    // Fetch the audio file
                    const response = await fetch(track.url);
                    const blob = await response.blob();

                    // Add to zip with sanitized filename
                    const filename = `${String(i + 1).padStart(2, '0')}. ${sanitizeFilename(track.name)}.flac`;
                    folder?.file(filename, blob);
                } catch (err) {
                    console.error(`Failed to download ${track.name}:`, err);
                }
            }

            // Update to show generation phase
            const progressText = progressDiv.querySelector('.text-sm');
            if (progressText) progressText.textContent = 'Generating zip file...';

            // Generate zip file
            const zipBlob = await zip.generateAsync({ type: 'blob' }, (metadata: any) => {
                const progressFill = document.getElementById('progress-fill');
                if (progressFill) progressFill.style.width = `${metadata.percent}%`;
            });

            // Download the zip
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            link.download = 'PTS v.IRL - The MARE-sical OST.zip';
            link.click();
            URL.revokeObjectURL(link.href);

            // Remove progress indicator
            progressDiv.remove();

        } catch (error) {
            console.error('Download failed:', error);
            alert('Failed to create download bundle. Please try again.');
            progressDiv.remove();
        }
    }

    function sanitizeFilename(name: string): string {
        // Remove invalid filename characters
        return name.replace(/[<>:"/\\|?*]/g, '').trim();
    }
</script>